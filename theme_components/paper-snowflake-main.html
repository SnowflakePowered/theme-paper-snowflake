<link rel="import" href="paper-snowflake-state">

<link rel="import" href="paper-snowflake-top">
<link rel="import" href="paper-snowflake-platform-selector">
<link rel="import" href="paper-fonts">
<link rel="import" href="paper-snowflake-games-container">
<link rel="import" href="paper-snowflake-game-details">

<link rel="import" href="../bower_components/core-animation/core-animation">
<link rel="import" href="../bower_components/paper-fab/paper-fab">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog">

<polymer-element name="paper-snowflake-main">
  <template>
    <style>

      :host {
        overflow: hidden;
        -webkit-user-select: none;
        user-select: none;
      }
      paper-snowflake-top {
        height: 100px;
      }
      .selectMain {
        height: 100%;
        display: table;
      }
      paper-snowflake-platform-selector {
        height: inherit;
        display: table-cell;
        min-width: 307px;
        border-right: 1px solid #dedede;
      }
      paper-snowflake-games-container {
        height: 100%;
        width: 99%;
        display: table-cell;
        background-color: white;
      }
      paper-snowflake-top:before {
        position: fixed;
        content: "";
        z-index: 1000;
        pointer-events: none;
        height: 100px;
        width: 100vw;
        margin-left: 307px;
        box-shadow: 0px 1px 5px rgba(0,0,0,0.3);

      }

      paper-snowflake-game-details {
        z-index: 1000000;
        position: fixed;
        width: 500px;
        height: 100vh;
        box-shadow: 0px 1px 5px rgba(0,0,0,0.3);
        -webkit-animation: slide-out 1s ease forwards;
      }
      .shown {
        -webkit-animation: slide 1s ease forwards;
      }
      #shadow {
        position: fixed;
        height: 100vh;
        z-index: 100000;
        width: 100vw;
        background-color: rgba(0,0,0,0.7);
      }
      @-webkit-keyframes slide {
        from {
          right: -5000px;
        }
        to {
          right: 0;
        }
      }
      @-webkit-keyframes slide-out {
        from {
          right: 0;
        }
        to {
          right: -5000px;
        }
      }
      .add-button {
        position: absolute;
        right: 25px;
        bottom: 25px;
      }

    </style>
    <paper-dialog id="addGameDialog" heading="Temporary Add Game">
      <input id="addGameFilename" type="text"></input>
      <button on-click="{{addGameButtonClick}}">Add this game</button>
    </paper-dialog>
    <core-animation id="fadeout" duration="500" target="{{$.shadow}}">
      <core-animation-keyframe>
        <core-animation-prop name="opacity" value="1"></core-animation-prop>
      </core-animation-keyframe>
      <core-animation-keyframe>
        <core-animation-prop name="opacity" value="0"></core-animation-prop>
      </core-animation-keyframe>
    </core-animation>
    <paper-snowflake-state id="state"
      availablePlatforms="{{availablePlatforms}}"
      selectedPlatform="{{selectedPlatform}}"
      selectedPlatformGames="{{selectedPlatformGames}}"
      showingDetails="{{showingDetails}}"
      selectedGame="{{selectedGame}}"
    ></paper-snowflake-state>
    <paper-snowflake-game-details id="detailsView" coverUrl="./cover.jpg" selectedGame="{{selectedGame}}"></paper-snowflake-game-details>
    <div id="shadow" style="display: none;" show="{{showingDetails}}" on-tap="{{_closeDetails}}"></div>
    <paper-snowflake-top selectedPlatform="{{selectedPlatform}}"></paper-snowflake-top>
    <section class="selectMain">
      <paper-snowflake-platform-selector selectedPlatform="{{selectedPlatform}}" availablePlatforms="{{availablePlatforms}}"></paper-snowflake-platform-selector>
      <paper-snowflake-games-container on-game-show="{{gameShow}}" selectedGame="{{selectedGame}}" selectedPlatform="{{selectedPlatform}}" selectedPlatformGames="{{selectedPlatformGames}}"></paper-snowflake-games-container>
      <paper-fab class="add-button" on-tap="{{addGame}}"></paper-fab>
    </section>
  </template>
  <script>
    Polymer('paper-snowflake-main', {
      ready: function() {
        window.du = this;
      },
      addGame: function(e) {
        this.$.addGameDialog.open();
      },
      addGameButtonClick: function() {
        var fileName = this.$.addGameFilename.value;
        var platformId = this.selectedPlatform.PlatformID;
        snowflake.getGameResults(fileName, platformId)
        .then(function(data) {
          return snowflake.getGameInfo(data[0].ID, fileName, platformId);
        })
        .then(snowflake.addGameInfo)
        .then(location.reload);
      },
      gameShow: function(e) {
        this.showingDetails = true;
      },
      showingDetailsChanged: function() {
        if (this.showingDetails === true) {
          this.showDetails();
        }
        if (this.showingDetails === false) {
          this.closeDetails();
        }
      },
      _closeDetails: function() {
        this.showingDetails = false;
      },
      closeDetails: function () {
        this.$.fadeout.direction = "normal";
        this.$.fadeout.play();
        var listener = (function(_this) {
            return function() {
              _this.$.shadow.style.display = "none";
              _this.$.detailsView.className = "";
              _this.$.fadeout.removeEventListener('core-animation-finish', this);
            };
          })(this);
        this.$.fadeout.addEventListener("core-animation-finish", listener)
      },
      showDetails: function() {
        this.showingDetails = true;
        this.$.shadow.style.display = "block";
        this.$.shadow.style.opacity = "0";
        this.$.fadeout.direction = "reverse";
        this.$.fadeout.play();
        var listener = (function(_this) {
            return function() {
              _this.$.shadow.style.opacity = "1";
              _this.$.shadow.style.display = "block";
              _this.$.detailsView.className = "shown";
              _this.$.fadeout.removeEventListener('core-animation-finish', this);
            };
          })(this);
        this.$.fadeout.addEventListener("core-animation-finish", listener)
      }
    });
  </script>
</polymer-element>
