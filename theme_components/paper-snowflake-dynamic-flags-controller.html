<link rel="import" href="paper-snowflake-dynamic-flag">
<link rel="import" href="paper-snowflake-emulator-selector">
<polymer-element name="paper-snowflake-dynamic-flags-controller" attributes="selectedGame">
  <template>
    <link rel="stylesheet" type="text/css" href="style/paper-snowflake-dynamic-flags-controller.css"/>
    <div class="emulator-selector">
      <span>Emulator &mdash;</span><paper-snowflake-emulator-selector selectedGame="{{selectedGame}}" selectedEmulator="{{selectedEmulator}}" availableEmulators="{{availableEmulators}}"></paper-snowflake-emulator-selector>
    </div>

    <template repeat="{{flag in fkeys | getKeys}}">
      <paper-snowflake-dynamic-flag on-flag-update="{{flagUpdate}}" flag="{{fkeys[flag]}}" value="{{fvalues[flag]}}" gameId="{{selectedGame.UUID}}" emulatorName="{{selectedEmulator.name}}"></paper-snowflake-dynamic-flag>
    </template>
  </template>
  <script>
    Polymer('paper-snowflake-dynamic-flags-controller', {
      publish: {
        fkeys : {},
        fvalues: {}
      },
      ready: function() {
        this.selected = 0;
        this.opened = false;
        window.d = this;
        this.valueSelected;
        this.defaultValues;
        this.commitQueue = {};
      },
      getKeys: function(o){
        return Object.keys(o);
      },
      flagUpdate: function(event){
        var flag = event.detail.flag;
        var value = event.detail.value;
        var locked = event.detail.locked;
        if(!locked){
          this.commitQueue[this.selectedEmulator.name][this.selectedGame.UUID][flag.Key] =  value;
          console.log("Committed value " + value + " to flag " + flag.Key);
        }
      },
      saveFlags: function(){
        if(this.selectedGame !== undefined && this.selectedGame !== null){
          console.log("Saving flags");
          var values = this.commitQueue[this.selectedEmulator.name][this.selectedGame.UUID];
          return snowflake.setFlagValues(this.selectedEmulator.name, this.selectedGame.UUID, values).then((function(_this) {
            return function() {
              _this.commitQueue[_this.selectedEmulator.name][_this.selectedGame.UUID] = {};
              return snowflake.getFlagValues(_this.selectedEmulator.name, _this.selectedGame.UUID);
            };
          })(this)).then((function(_this) {
            return function() {
              return _this.fvalues = data;
            };
          })(this));
        }
      },
      flagReset: function(){
        this.commitQueue[this.selectedEmulator.name] = {};
        this.commitQueue[this.selectedEmulator.name][this.selectedGame.UUID] = {};

        if(this.selectedGame !== undefined && this.selectedGame !== null){
          snowflake.getEmulatorFlags(this.selectedEmulator.name).then((function(_this) {
            return function(data) {
              _this.fkeys = data;
              return snowflake.getFlagDefaultValues(_this.selectedEmulator.name);
            };
          })(this)).then((function(_this) {
            return function(data) {
              _this.defaultValues = data;
              return snowflake.getFlagValues(_this.selectedEmulator.name, _this.selectedGame.UUID);
            };
          })(this)).then((function(_this) {
            return function(data) {
              var _defaultValues, _flagValues, flag, i, len, locked, ref, results;
              _flagValues = data;
              _defaultValues = _this.defaultValues;
              ref = Object.keys(_this.fkeys);
              results = [];
              for (i = 0, len = ref.length; i < len; i++) {
                flag = ref[i];
                locked = (localStorage.getItem("unlocked_" + _this.selectedGame.UUID + ";" + _this.selectedEmulator.name + ";" + _this.fkeys[flag].Key) === null);
                if (locked) {
                  results.push(_this.commitQueue[_this.selectedEmulator.name][_this.selectedGame.UUID][key] = _defaultValues[key]);
                } else {
                  results.push(_this.commitQueue[_this.selectedEmulator.name][_this.selectedGame.UUID][key] = _flagValues[key]);
                }
              }
              return results;
            };
          })(this));
          }

              //todo rewrite this to only make changes to commitQuueu

      },
      selectedEmulatorChanged: function(){
        this.async(function() {
          this.flagReset();
        }, null, 100);
      },
      selectedGameChanged: function(){
        console.log("game chaged");
        this.async(function() {
          this.flagReset();
        }, null, 100);
      }
    });
  </script>
</polymer-element>
<paper-snowflake-dynamic-flags-controller></paper-snowflake-dynamic-flags-controller>
