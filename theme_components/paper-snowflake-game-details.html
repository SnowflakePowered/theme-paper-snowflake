<script src="../bower_components/color-thief/src/color-thief.js"></script>

<link rel="import" href="../bower_components/paper-tabs/paper-tabs">
<link rel="import" href="../bower_components/paper-fab/paper-fab">
<link rel="import" href="../bower_components/core-pages/core-pages">
<link rel="import" href="../bower_components/core-icons/core-icons">
<link rel="import" href="../bower_components/core-icons/av-icons">


<link rel="import" href="paper-fonts">
<link rel="import" href="paper-snowflake-dynamic-flags">

<polymer-element name="paper-snowflake-game-details" attributes="coverUrl selectedGame opened smallDetailText">
  <template>
    <link rel="stylesheet" type="text/css" href="style/paper-snowflake-game-details.css" />

    <div id="container" class="container">
      <section class="cover">
        <img draggable="false" id="gameCover" class="game-cover" src="{{coverUrl}}">
      </section>
      <section class="main">
        <header class="title-info">
          <paper-fab id="playButton" class="play-button" icon="av:play-arrow" on-tap="{{gamePlay}}"></paper-fab>
          <div class="title-interior">
            <h1 class="title-name">{{selectedGame.Name}}</h1>
            <div class="title-publisher">{{selectedGame.Metadata.game_publisher}}</div>
            <div class="title-detail"><span class="detail-text">{{smallDetailText}}</span></div>
          </div>
        </header>
        <section class="bottom">
          <paper-tabs id="selector" selected="{{selected}}">
            <paper-tab>OVERVIEW</paper-tab>
            <paper-tab>SETTINGS</paper-tab>
          </paper-tabs>
          <div class="info-area">
            <core-pages style="position: relative; height: 100%;" selected="{{selected}}">
              <div style="display: table-cell; height: 100%;">
                <p fit class="game-description">
                  {{selectedGame.Metadata.game_description}}
                </p>
              </div>
              <div style="padding-top: 10px;">
                <paper-snowflake-dynamic-flags selectedGame="{{selectedGame}}"></paper-snowflake-dynamic-flags>
              </div>
            </core-pages>
          </div>
        </section>
      </section>
    </div>
    <div class="hidden" id="shadow" on-tap="{{close}}"></div>
  </template>
  <script>
    Polymer('paper-snowflake-game-details', {
      palette: {},
      dominantColor: '',
      contrastColor: '',
      blackWhiteColor: '',
      idealGrey: function(r, g, b) {
        var nThreshold = 105;
        var bgDelta = (r * 0.299) + (g * 0.587) + (b * 0.114);

        return ((255 - bgDelta) < nThreshold) ? "#666666" : "#d1d1d1";
      },
      idealBW: function(r, g, b) {
        var nThreshold = 105;
        var bgDelta = (r * 0.299) + (g * 0.587) + (b * 0.114);

        return ((255 - bgDelta) < nThreshold) ? "#000000" : "#ffffff";
      },
      getColors: function(coverUrl) {
        var img = new Image();
        img.crossOrigin = 'Anonymous';
        img.src = coverUrl;
        console.log(img.src);
        img.onload = (function(_this) {
          return function() {
            var thief = new ColorThief();
            var color = thief.getColor(img);
            _this.dominantColor = "rgb(" + color + ")";
            _this.contrastColor = _this.idealGrey(color[0], color[1], color[2]);
            _this.blackWhiteColor = _this.idealBW(color[0], color[1], color[2]);
            _this.palette = (function() {
              var i, len, ref, results;
              ref = thief.getPalette(img);
              results = [];
              for (i = 0, len = ref.length; i < len; i++) {
                p = ref[i];
                results.push("rgb(" + p[0] + ',' + p[1] + ',' + p[2] + ")");
              }
              delete img;
              delete thief;
              delete color;
              return results;
            })();
          };
        })(this);
      },
      open: function() {
        this.opened = true;
        this.$.container.className += " opened";
        this.$.shadow.className = "opened";
        this.async(function() {
          this.getColors(this.coverUrl);
        }, null, 200);
      },
      close: function() {
        this.opened = false;
        this.$.container.className = "container";
        this.$.shadow.className = "hidden";
      },
      ready: function() {
        this.selected = 0;
        this.opened = false;
      },
      gamePlay: function(e) {
        this.fire('game-play', {game: this.game});
        event.stopPropagation();
      }
    });
  </script>
</polymer-element>
<paper-snowflake-game-details coverUrl="cover.jpg"></paper-snowflake-game-details>
